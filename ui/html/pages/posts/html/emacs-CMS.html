<p>
  <title>Emacs CMS</title>
</p>
<summary>
  Using Emacs as a CMS with a simple Node application using HTML templates and HTMX
</summary>
<h1>Emacs CMS</h1>
<small class="date">Published: Fri, 02 Feb 2024 09:47:54-4:00</small>
<br>
<small class="tech">Elisp | HTMX | JavaScript</small>

<div id="outline-container-org1f55f44" class="outline-2">
  <h2 id="org1f55f44">New Implementation</h2>
  <div class="outline-text-2" id="text-org1f55f44">
    <p>
      The following in this blog all remains the case for the current production version of the blog, but I have
      recently started a new version using Bun in Place of Node and I am using TypeScript in place of vanilla JS.
      Instead of using Express, I am creating a new API from scratch with the built in <code>Bun.serve()</code>. I also
      decided to replace squirrelly templates with mustache.js templates to try a different approach to HTML templates.
      For now I think I will stick with using Cheerio to parse the HTML for data, but perhaps I will switch that out as
      well as the project moves forward. I am also adding some better logic for dealing with images so I can handle
      different file formats. So far I am happy with this new implementation. Using Bun's built in method for sending
      and receiving HTTP requests is much more in keeping with the overall theme of simplicity I am trying to go for
      with this project. I will probably switch to this newer version when its done.
    </p>
  </div>
</div>
<div id="outline-container-orgd87f471" class="outline-2">
  <h2 id="orgd87f471">Emacs Org Mode as a CMS</h2>
  <div class="outline-text-2" id="text-orgd87f471">
    <p>
      I played around with a few ideas of how I would make this blog, but finally settled on a workflow where I could
      upload my org files to a remote server using a simple Node app, <a href="https://htmx.org/">HTMX</a>, and
      functionality that comes built into Emacs. I organize my notes with <a
        href="https://protesilaos.com/emacs/denote">Denote.el</a>, so I settled on a setup where I didn't need to leave
      my editor to update my blog. I will be much more liable to keep my projects blog up to date if I have an easily
      accessible workflow. Here is a basic outline of the steps I took to get this up and running excluding the setup of
      the sever itself (I used <a href="https://www.digitalocean.com/">Digital Ocean</a> and <a
        href="https://nginx.org/">Nginx</a>, but any VPS will do fine). The full code is <a
        href="https://github.com/Naokotani/blog">here</a> on my GitHub account.
    </p>
  </div>
</div>
<div id="outline-container-orgef06325" class="outline-2">
  <h2 id="orgef06325">Export Org files to the remote server</h2>
  <div class="outline-text-2" id="text-orgef06325">
    <p>
      First I save the file to a blog directory on my local file system and use rsync with
      <code>OK-IF-ALREADY-EXISTS</code> set to <code>t</code> in order to update the blog post on my remote file system.
      I just export the body without any head section or doctype. If this is a new blog, I put a thumbnail for it in the
      blog/images directory which will be updated when I run the function.
    </p>

    <div class="org-src-container">
      <pre class="src src-emacs-lisp"> <span style="color: #379cf6;">(</span><span
          style="color: #6f80ff; font-weight: bold;">defun</span> <span
          style="color: #0dafdf;">nao/export-org-to-blog</span> <span style="color: #d0730f;">()</span>
        <span style="color: #d0730f;">(</span><span style="color: #6f80ff; font-weight: bold;">interactive</span><span
          style="color: #d0730f;">)</span>
        <span style="color: #d0730f;">(</span><span style="color: #6f80ff; font-weight: bold;">setq</span>
        org-html-doctype <span style="color: #df805f;">"html5"</span><span style="color: #d0730f;">)</span>
        <span style="color: #d0730f;">(</span><span style="color: #6f80ff; font-weight: bold;">let</span> <span
          style="color: #6f80ff;">(</span><span style="color: #df805f;">(</span>filename <span
          style="color: #0dafdf;">(</span>org-html-export-to-html nil nil nil t<span
          style="color: #0dafdf;">)</span><span style="color: #df805f;">)</span><span style="color: #6f80ff;">)</span>
        <span style="color: #6f80ff;">(</span>copy-file <span style="color: #df805f;">(</span>concat <span
          style="color: #0dafdf;">(</span>file-name-sans-extension filename<span style="color: #0dafdf;">)</span> <span
          style="color: #df805f;">".png"</span><span style="color: #df805f;">)</span>
        <span style="color: #df805f;">"/rsync:server:/path/to/images"</span> t<span style="color: #6f80ff;">)</span>
        <span style="color: #6f80ff;">(</span>copy-file filename <span
          style="color: #df805f;">"/rsync:server/path/to/html"</span> t<span style="color: #6f80ff;">)</span><span
          style="color: #d0730f;">)</span><span style="color: #379cf6;">)</span>
      </pre>
    </div>

    <p>
      In order to get the file to save with the correct name, I manually set the file name using
      <code>EXPORT_FILE_NAME</code> like so <code>#+EXPORT_FILE_NAME:
        ~/Documents/denote/blog/programming-blog.html</code>. That's it on the Emacs side, not much to it.
    </p>
  </div>
</div>
<div id="outline-container-org8e531aa" class="outline-2">
  <h2 id="org8e531aa">Server side</h2>
  <div class="outline-text-2" id="text-org8e531aa">
    <p>
      Server side I use a simple Node app that uses <a href="https://expressjs.com/">Express</a> to create a REST API
      that grabs the filenames, which are already in slug format, to create the list of links for the blog posts. The
      if/blocks are used to either make the response the full page if they navigate form outside the website, or just
      the content if they use internal navigation.
    </p>

    <div class="org-src-container">
      <pre class="src src-javascript">
        app.get<span style="color: #379cf6;">(</span><span style="color: #df805f;">'/blog/*'</span>, <span
          style="color: #6f80ff; font-weight: bold;">async</span> <span
          style="color: #6f80ff; font-weight: bold;">function</span> <span style="color: #d0730f;">(</span><span
          style="color: #af85ff;">req</span>, <span style="color: #af85ff;">res</span><span
          style="color: #d0730f;">)</span> <span style="color: #d0730f;">{</span>
        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">slug</span> =
        req.params<span style="color: #6f80ff;">[</span>0<span style="color: #6f80ff;">]</span>;
        <span style="color: #6f80ff; font-weight: bold;">if</span> <span
          style="color: #6f80ff;">(</span>req.headers<span style="color: #df805f;">[</span><span
          style="color: #df805f;">"hx-request"</span><span style="color: #df805f;">]</span> === <span
          style="color: #df805f;">"true"</span><span style="color: #6f80ff;">)</span> <span
          style="color: #6f80ff;">{</span>
        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">path</span> = <span
          style="color: #df805f;">'/path/to/blog/'</span>
        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">data</span> = <span
          style="color: #6f80ff; font-weight: bold;">await</span> fs.readFile<span
          style="color: #df805f;">(</span>path+slug, <span style="color: #df805f;">'utf8'</span><span
          style="color: #df805f;">)</span>
        res.send<span style="color: #df805f;">(</span>data<span style="color: #df805f;">)</span>;
        <span style="color: #6f80ff;">}</span> <span style="color: #6f80ff; font-weight: bold;">else</span> <span
          style="color: #6f80ff;">{</span>
        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">route</span> = <span
          style="color: #df805f;">[</span>slug<span style="color: #df805f;">]</span>

        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">data</span> = <span
          style="color: #df805f;">{</span>
        route: route,
        <span style="color: #df805f;">}</span>

        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">html</span> =
        Sqrl.render<span style="color: #df805f;">(</span>newRoute<span style="color: #0dafdf;">()</span>, data<span
          style="color: #df805f;">)</span>;
        res.send<span style="color: #df805f;">(</span>html<span style="color: #df805f;">)</span>;
        <span style="color: #6f80ff;">}</span>
        <span style="color: #d0730f;">}</span><span style="color: #379cf6;">)</span>

      </pre>
    </div>

    <p>
      I use the <a href="https://squirrelly.js.org/">squirrel</a> templates to create the different content such as the
      lists of links and cards. For example, you can set up links like this:
    </p>

    <div class="org-src-container">
      <pre class="src src-javascript">&lt;nav&gt;
        &lt;h2 <span style="color: #6f80ff; font-weight: bold;">class</span>=<span
          style="color: #df805f;">"post-header"</span>&gt;Projects&lt;/h2&gt;
        &lt;ul&gt;
        <span style="color: #379cf6;">{</span><span style="color: #d0730f;">{</span>@each<span
          style="color: #6f80ff;">(</span>it.files<span style="color: #6f80ff;">)</span> =&gt; val, index<span
          style="color: #d0730f;">}</span><span style="color: #379cf6;">}</span>
        &lt;li&gt;
        &lt;a href=<span style="color: #df805f;">"#"</span> hx-push-url=<span style="color: #df805f;">"true"</span>
        hx-get=<span style="color: #df805f;">"a-domain.com/blog/{{val}}"</span> hx-target=<span
          style="color: #df805f;">"#contentDiv"</span> hx-swap=<span style="color: #df805f;">"innerHTML"</span>&gt;
        <span style="color: #379cf6;">{</span><span style="color: #d0730f;">{</span>it.labels<span
          style="color: #6f80ff;">[</span>index<span style="color: #6f80ff;">]</span><span
          style="color: #d0730f;">}</span><span style="color: #379cf6;">}</span>
        &lt;/a&gt;
        &lt;/li&gt;
        <span style="color: #379cf6;">{</span><span style="color: #d0730f;">{</span><span
          style="color: #df805f;">/each}}</span>
        <span style="color: #df805f;"> &lt;/</span>ul&gt;
        &lt;/nav&gt;
      </pre>
    </div>

    <p>
      This will create a list of links from the filenames and then when the links are clicked, they will swap with the
      content that is currently in the <code>#contentDiv</code>.
    </p>
  </div>
</div>
<div id="outline-container-org6840b28" class="outline-2">
  <h2 id="org6840b28">Images and Summaries for cards</h2>
  <div class="outline-text-2" id="text-org6840b28">
    <p>
      In order to get a summary for each file I add a <code>&lt;p&gt;</code> tag with the summary class at the top of my
      org file and then I use <a href="https://cheerio.js.org/">cheerio</a> to parse the html and pull out the summary
      text. I then just use a CSS <code>display: none;</code> so the summary doesn't appear in the actual blog post. To
      get the image I simply split the filename and replace .html with .png. If you wanted to use multiple file types it
      would be simple enough to create a more elaborate solution, but my screenshot app defaults to png, which is
      acceptable for the purposes of a simple blog.
    </p>

    <div class="org-src-container">
      <pre class="src src-javascript"> #+BEGIN_summary
        Using Emacs as a CMS <span style="color: #6f80ff; font-weight: bold;">with</span> a simple Node application
        using HTML templates and HTMX
        #+END_summary

        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">files</span> = <span
          style="color: #6f80ff; font-weight: bold;">await</span> fs.readdir<span
          style="color: #379cf6;">(</span>path<span style="color: #379cf6;">)</span>;

        <span style="color: #6f80ff; font-weight: bold;">for</span> <span style="color: #379cf6;">(</span>file <span
          style="color: #6f80ff; font-weight: bold;">of</span> files<span style="color: #379cf6;">)</span> <span
          style="color: #379cf6;">{</span>
        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">img</span> =
        file.split<span style="color: #d0730f;">(</span><span style="color: #df805f;">"."</span><span
          style="color: #d0730f;">)</span>;
        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">data</span> = <span
          style="color: #6f80ff; font-weight: bold;">await</span> fs.readFile<span
          style="color: #d0730f;">(</span>path+file, <span style="color: #df805f;">'utf8'</span><span
          style="color: #d0730f;">)</span>;
        links.push<span style="color: #d0730f;">(</span>file<span style="color: #d0730f;">)</span>;
        titles.push<span style="color: #d0730f;">(</span>makeTitle<span style="color: #6f80ff;">(</span>file<span
          style="color: #6f80ff;">)</span><span style="color: #d0730f;">)</span>;
        images.push<span style="color: #d0730f;">(</span>img<span style="color: #6f80ff;">[</span>0<span
          style="color: #6f80ff;">]</span> + <span style="color: #df805f;">".png"</span><span
          style="color: #d0730f;">)</span>
        <span style="color: #6f80ff; font-weight: bold;">const</span> <span style="color: #af85ff;">$</span> =
        cheerio.load<span style="color: #d0730f;">(</span>data<span style="color: #d0730f;">)</span>;
        summaries.push<span style="color: #d0730f;">(</span>$<span style="color: #6f80ff;">(</span><span
          style="color: #df805f;">'div.summary p'</span><span style="color: #6f80ff;">)</span>.text<span
          style="color: #6f80ff;">()</span><span style="color: #d0730f;">)</span>;
        <span style="color: #379cf6;">}</span>
      </pre>
    </div>
  </div>
</div>
<div id="outline-container-org4e86b69" class="outline-2">
  <h2 id="org4e86b69">Problems with this Workflow</h2>
  <div class="outline-text-2" id="text-org4e86b69">
    <p>
      The major issue with this workflow is that I don't have a lot of control the HTML that org export creates. It is
      possible to customize it further, but it requires quite a bit of customization. As is stands you would most likely
      need to write custom CSS to target the classes that org export creates, which are named well and extensive enough
      to do what you need. If you want to make use of bootstrap or another CSS framework, there are probably much easier
      ways to produce a blog than this, but if you don't mind writing CSS, its a pretty simple elegant solution.
    </p>
  </div>
</div>
<div id="outline-container-orgff19d8b" class="outline-2">
  <h2 id="orgff19d8b">Future plans for the Project</h2>
  <div class="outline-text-2" id="text-orgff19d8b">
    <p>
      Aside from tweaking the CSS to get it work better on different screen sizes and improve the overall look and feel,
      I would like to add some logic to add a default thumbnail if I don't specific one by putting it in the blog
      directory. As the blog grows I might also try to implement a directory structure that would be reflected on the UI
      by nesting the posts under categories, JavaScript, Rust, Ideas, etc.
    </p>
  </div>
</div>
